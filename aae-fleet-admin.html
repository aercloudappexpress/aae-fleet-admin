<!--
@license
Copyright (c) 2015 The AerCloud Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://aercloud.github.io/LICENSE.txt
The complete set of authors may be found at http://aercloud.github.io/AUTHORS.txt
The complete set of contributors may be found at http://aercloud.github.io/CONTRIBUTORS.txt
Code distributed by Aeris as part of the aercloud project is also
subject to an additional IP rights grant found at http://aercloud.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../aae-aercloud-behaviors/aae-aercloud-config-behavior.html">

<!--
An element for managing the fleet resource.

Example:

    <aae-fleet-admin account={{account}} api-key={{apiKey}}></aae-fleet-admin>

@demo demo/index.html
-->

<dom-module id="aae-fleet-admin">
  <template>
    <iron-ajax id="fleetAjax"
      content-type="application/json" handle-as="json"
      on-response="handleFleetResponse"
      on-error="handleFleetError"
      debounce-duration="300"></iron-ajax>

    <iron-ajax id="deviceAjax"
      content-type="application/json" handle-as="json"
      on-response="handleDeviceResponse"
      on-error="handleDeviceError"
      debounce-duration="300"></iron-ajax>

    <iron-ajax id="vehicleAjax"
      content-type="application/json" handle-as="json"
      on-response="handleVehicleResponse"
      on-error="handleVehicleError"
      debounce-duration="300"></iron-ajax>

    <iron-ajax id="driverAjax"
      content-type="application/json" handle-as="json"
      on-response="handleDriverResponse"
      on-error="handleDriverError"
      debounce-duration="300"></iron-ajax>

    <iron-ajax id="stationAjax"
      content-type="application/json" handle-as="json"
      on-response="handleStationResponse"
      on-error="handleStationError"
      debounce-duration="300"></iron-ajax>

    <iron-ajax id="placeAjax"
      content-type="application/json" handle-as="json"
      on-response="handlePlaceResponse"
      on-error="handlePlaceError"
      debounce-duration="300"></iron-ajax>      

    <label>ID: [[fleetSummary.id]]</label></p>
    <label>Name: [[fleetSummary.name]]</label></p>
    <label>Total Devices: [[deviceSummary.count]]</label></p>
    <label>Total Vehicles: [[vehicleSummary.count]]</label></p>
    <label>Total Drivers: [[driverSummary.count]]</label></p>
    <label>Total Stations: [[stationSummary.count]]</label></p>
    <label>Total Places: [[placeSummary.count]]</label></p>

  </template>

  <script>
  (function(){
    Polymer({
      is: 'aae-fleet-admin',

      behaviors: [AppExpress.AerCloudConfig],

      /**
       * Public properties
       */
      properties: {
      },

      // Element Lifecycle

      ready: function() {
        // `ready` is called after all elements have been configured, but
        // propagates bottom-up. This element's children are ready, but parents
        // are not.
        //
        // This is the point where you should make modifications to the DOM (when
        // necessary), or kick off any processes the element wants to perform.
        console.log('ready');

        // ------ semi-private properties in this element --------

        this.setFleetSummary({
          "id": this.account,
          "name": ""          
        });

        this.setDeviceSummary({
          "count": 0
        });

        this.setVehicleSummary({
          "count": 0
        });

        this.setDriverSummary({
          "count": 0
        });

        this.setStationSummary({
          "count": 0
        }); 

        this.setPlaceSummary({
          "count": 0
        });              
        // ------ end of semi-private properties
      },

      attached: function() {
        // `attached` fires once the element and its parents have been inserted
        // into a document.
        //
        // This is a good place to perform any work related to your element's
        // visual state or active behavior (measuring sizes, beginning animations,
        // loading resources, etc).
        this.refresh();
      },

      detached: function() {
        // The analog to `attached`, `detached` fires when the element has been
        // removed from a document.
        //
        // Use this to clean up anything you did in `attached`.
      },

      // Element Behavior
      setFleetSummary: function(newSummary) {
        this.set('fleetSummary', newSummary);
      },

      setDeviceSummary: function(newSummary) {
        this.set('deviceSummary', newSummary);
      },

      setVehicleSummary: function(newSummary) {
        this.set('vehicleSummary', newSummary);
      },

      setDriverSummary: function(newSummary) {
        this.set('driverSummary', newSummary);
      },     

      setStationSummary: function(newSummary) {
        this.set('stationSummary', newSummary);
      },

      setPlaceSummary: function(newSummary) {
        this.set('placeSummary', newSummary);
      },      

      refresh: function() {
        console.log("account=" + this.account);
        console.log("apiKey=" + this.apiKey);
        console.log("container=" + this.container);

        var validated = false;
        validated = this.account !== undefined && this.account.trim() !== "";
        validated = this.apiKey !== undefined && this.apiKey.trim() !== "";
        validated = this.container !== undefined && this.container.trim() !== "";
        console.log("validated=" + validated);

        if (validated) {
          this.updateFleetSummary();
        }
      },

      updateFleetSummary: function() {
        console.log("Updating fleet summary");

        var ajax = this.$.fleetAjax;
        ajax.url = this.endpoint + "/" + this.account + "/";
        ajax.params['apiKey'] = this.apiKey;
        ajax.generateRequest();
      },

      handleFleetResponse: function(e, req) {
        console.log("Fleet request successful");
        console.log(req.response);

        // TODO add name
        this.setFleetSummary({
            "id": this.account
        });

        // Call AerCloud to update device summary
        var ajax = this.$.deviceAjax;
        ajax.url = this.endpoint + "/" + this.account + "/scls/groups/_dev/members";
        ajax.params['apiKey'] = this.apiKey;
        ajax.generateRequest();
      },

      handleFleetError: function(err) {
        console.log(err);
      },

      handleDeviceResponse: function(e, req) {
        console.log("Device request successful");
        console.log(req.response);

        this.setDeviceSummary({"count": req.response.ids.length});

        // Call AerCloud to update vehicle summary
        var ajax = this.$.vehicleAjax;
        ajax.url = this.endpoint + "/" + this.account + "/scls/groups/_veh/members";
        ajax.params['apiKey'] = this.apiKey;
        ajax.generateRequest();        
      },

      handleDeviceError: function(err) {
        console.log(err);
      },

      handleVehicleResponse: function(e, req) {
        console.log("Vehicle request successful");
        console.log(req.response);

        this.setVehicleSummary({"count": req.response.ids.length});

        // Call AerCloud to update driver summary
        var ajax = this.$.driverAjax;
        ajax.url = this.endpoint + "/" + this.account + "/scls/groups/_drv/members";
        ajax.params['apiKey'] = this.apiKey;
        ajax.generateRequest();
      },

      handleVehicleError: function(err) {
        console.log(err);
      },

      handleDriverResponse: function(e, req) {
        console.log("Driver request successful");
        console.log(req.response);

        this.setDriverSummary({"count": req.response.ids.length});

        // Call AerCloud to update station summary
        var ajax = this.$.stationAjax;
        ajax.url = this.endpoint + "/" + this.account + "/scls/groups/_sta/members";
        ajax.params['apiKey'] = this.apiKey;
        ajax.generateRequest();
      },

      handleDriverError: function(err) {
        console.log(err);
      },

      handleStationResponse: function(e, req) {
        console.log("Station request successful");
        console.log(req.response);

        this.setStationSummary({"count": req.response.ids.length});

        // Call AerCloud to update place summary
        var ajax = this.$.placeAjax;
        ajax.url = this.endpoint + "/" + this.account + "/scls/groups/_plc/members";
        ajax.params['apiKey'] = this.apiKey;
        ajax.generateRequest();
      },

      handleStationError: function(err) {
        console.log(err);
      },

      handlePlaceResponse: function(e, req) {
        console.log("Place request successful");
        console.log(req.response);

        this.setPlaceSummary({"count": req.response.ids.length});

      },

      handlePlaceError: function(err) {
        console.log(err);
      }                         

    });
  })();
  </script>
</dom-module>
